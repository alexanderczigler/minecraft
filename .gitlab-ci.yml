image: docker:latest

services:
- docker:dind

discord:
  stage: build
  script:
  - docker_build "discord" "latest"

overviewer:
  stage: build
  script:
  - docker_build "overviewer" "1.12" "VERSION=1.12.2"
  - docker_build "overviewer" "1.13" "VERSION=1.13.2"
  - docker_build "overviewer" "1.14" "VERSION=1.14.2"

server:
  stage: build
  script:
  - docker_build "server" "1.12" "JAR=https://launcher.mojang.com/v1/objects/886945bfb2b978778c3a0288fd7fab09d315b25f/server.jar"
  - docker_build "server" "1.13" "JAR=https://launcher.mojang.com/v1/objects/3737db93722a9e39eeada7c27e7aca28b144ffa7/server.jar"
  - docker_build "server" "1.14" "JAR=https://launcher.mojang.com/v1/objects/808be3869e2ca6b62378f9f4b33c946621620019/server.jar"

.auto_devops: &auto_devops |
  [[ "$TRACE" ]] && set -x

  function docker_build() {
    if [ ! -z "$3" ]; then
      docker build --pull -t "$CI_REGISTRY_IMAGE/$1:$2" $1 --build-arg "$3"
    else
      docker build --pull -t "$CI_REGISTRY_IMAGE/$1:$2" $1
    fi

    docker push "$CI_REGISTRY_IMAGE/$1:$2"
  }

before_script:
- docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
- *auto_devops

stages:
- build
